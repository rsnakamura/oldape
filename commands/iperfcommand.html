<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>The Iperf Command &mdash; APETools 0.0.3 documentation</title>
    
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootswatch-3.3.4/spacelab/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="APETools 0.0.3 documentation" href="../index.html" />
    <link rel="up" title="Commands" href="index.html" />
    <link rel="prev" title="apetools.commands.ipconfig.Ipconfig.address" href="api/apetools.commands.ipconfig.Ipconfig.address.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          APETools</a>
        <span class="navbar-text navbar-version pull-left"><b>0.0.3</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../documentation/user/index.html">User Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/developer/index.html">Developer Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../baseclass.html">The BaseClass</a></li>
<li class="toctree-l1"><a class="reference internal" href="../log_setter.html">The Log Setter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../main.html">The Main Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../readme.html">All-in-one Performance Evaluation Tools (Read Me)</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../affectors/index.html">Affectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../builders/index.html">Builders</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commons/index.html">Commons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../connections/index.html">Connections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devices/index.html">Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../informants/index.html">Informants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lexicographers/index.html">Lexicographers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../operations/index.html">Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parameters/index.html">Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parsers/index.html">Parsers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pipes/index.html">Pipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../proletarians/index.html">Proletarians</a></li>
<li class="toctree-l1"><a class="reference internal" href="../threads/index.html">Threads</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchers/index.html">Watchers</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">The Iperf Command</a><ul>
<li><a class="reference internal" href="#errors-raised">Errors Raised</a><ul>
<li><a class="reference internal" href="#iperferror">IperfError</a></li>
<li><a class="reference internal" href="#iperfcommanderror">IperfCommandError</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-iperf-command-enum">The Iperf Command Enum</a></li>
<li><a class="reference internal" href="#iperf-command">The Iperf Command</a><ul>
<li><a class="reference internal" href="#daemon-mode">Daemon Mode</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-run-method">The <cite>run</cite> Method</a><ul>
<li><a class="reference internal" href="#setup">Setup</a></li>
<li><a class="reference internal" href="#traverse">Traverse</a><ul>
<li><a class="reference internal" href="#the-main-path">The Main Path</a></li>
<li><a class="reference internal" href="#the-abort-path">The Abort Path</a></li>
<li><a class="reference internal" href="#the-stop-path">The Stop Path</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#the-cleanup">The Cleanup</a></li>
<li><a class="reference internal" href="#testing-the-iperf-command">Testing The Iperf Command</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="api/apetools.commands.ipconfig.Ipconfig.address.html" title="Previous Chapter: apetools.commands.ipconfig.Ipconfig.address"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; apetools.comm...</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/commands/iperfcommand.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="the-iperf-command">
<h1>The Iperf Command<a class="headerlink" href="#the-iperf-command" title="Permalink to this headline">¶</a></h1>
<p>A module to hold a generic iperf command.</p>
<div class="code highlight-python"><div class="highlight"><pre><span></span>&lt;class &#39;ImportError&#39;&gt;
No module named &#39;Queue&#39;
</pre></div>
</div>
<div class="section" id="errors-raised">
<h2>Errors Raised<a class="headerlink" href="#errors-raised" title="Permalink to this headline">¶</a></h2>
<div class="section" id="iperferror">
<span id="iperf-error"></span><h3>IperfError<a class="headerlink" href="#iperferror" title="Permalink to this headline">¶</a></h3>
<p>The <cite>IperfError</cite> is raised if a problem with the connection between the client and server is detected.</p>
<p class="plantuml">
<img src="../_images/plantuml-b59446823354430bd71e8ae3115cfa9bbc5b4265.png" alt="IperfError -|&gt; CommandError" />
</p>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">IperfError</span></code></td>
<td></td>
</tr>
</tbody>
</table>
<div class="code highlight-python"><div class="highlight"><pre><span></span>&lt;class &#39;NameError&#39;&gt;
name &#39;CommandError&#39; is not defined
</pre></div>
</div>
</div>
<div class="section" id="iperfcommanderror">
<h3>IperfCommandError<a class="headerlink" href="#iperfcommanderror" title="Permalink to this headline">¶</a></h3>
<p>The <cite>IperfCommandError</cite> is raised if an error in the command-string is detected.</p>
<p class="plantuml">
<img src="../_images/plantuml-a6a7ca7c23b3f6d34868be5f5ec6e43ec2337697.png" alt="IperfCommandError -|&gt; ConfigurationError" />
</p>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">IperfCommandError</span></code></td>
<td></td>
</tr>
</tbody>
</table>
<div class="code highlight-python"><div class="highlight"><pre><span></span>&lt;class &#39;NameError&#39;&gt;
name &#39;ConfigurationError&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="section" id="the-iperf-command-enum">
<h2>The Iperf Command Enum<a class="headerlink" href="#the-iperf-command-enum" title="Permalink to this headline">¶</a></h2>
<p>The <cite>IperfCommandEnum</cite> holds string constants for the <a class="reference internal" href="../documentation/developer/commands/iperfcommand.html#iperf-command"><span>IperfCommand</span></a>.</p>
<p class="plantuml">
<img src="../_images/plantuml-9971b3d049f1fb22a5c3daa7ea6e7814f07326f6.png" alt="IperfCommandEnum : client
IperfCommandEnum : server
IperfCommandEnum : time
IperfCommandEnum : eof
IperfCommandEnum : newline
IperfCommandEnum : udp
IperfCommandEnum : path
IperfCommandEnum : iperf" />
</p>
</div>
<div class="section" id="iperf-command">
<span id="id1"></span><h2>The Iperf Command<a class="headerlink" href="#iperf-command" title="Permalink to this headline">¶</a></h2>
<p>The <cite>IperfCommand</cite> executes iperf commands. This is very old code so it is not well-documented.</p>
<div class="section" id="daemon-mode">
<h3>Daemon Mode<a class="headerlink" href="#daemon-mode" title="Permalink to this headline">¶</a></h3>
<p>The most recent change is a check for the <cite>&#8211;daemon</cite> flag in the parameters. If this is there, then it is assumed that the server will want to start, redirect the output to a file, then close the connection to the device. Another object will then have to kill the iperf process and copy it if the output is wanted. This is being implemented speciffically for the <cite>ipad</cite> running downlink iperf traffic. It probably will not work in other cases.</p>
<p>Because the server is running in a thread, it will set a <code class="docutils literal"><span class="pre">self.last_filename</span></code> property so that users will know where to get the remote file.</p>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">IperfCommand</span></code></td>
<td></td>
</tr>
</tbody>
</table>
<p class="plantuml">
<img src="../_images/plantuml-cb3ff3b842d1e5f7e655a8a546938655e74d92e0.png" alt="IperfCommand -|&gt; BaseThreadClass
IperfCommand o-- StoragePipe
IperfCommand : parameters
IperfCommand : output
IperfCommand : role
IperfCommand : base_filename
IperfCommand : raw_iperf
IperfCommand : parser
IperfCommand : run(device, filename, server)
IperfCommand : start(device, filename)
IperfCommand : __call__(device, filename, server)
IperfCommand : last_filename
IperfCommand : is_daemon" />
</p>
</div>
</div>
<div class="section" id="the-run-method">
<h2>The <cite>run</cite> Method<a class="headerlink" href="#the-run-method" title="Permalink to this headline">¶</a></h2>
<p>There are two parts to the <cite>IperfCommand.run</cite> method:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Setup</li>
<li>Traverse</li>
</ol>
</div></blockquote>
<div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h3>
<p>The setup involves the following steps:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Add tags to the filename to make it easier to identify:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">device</span><span class="o">.</span><span class="n">role</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Turn off the output pipeline&#8217;s screen output so the parser can do it instead:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">unset_emit</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p class="first">Open an output file using the updated filename:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">file_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Wait for the connection lock (in case others have the connection) and run the command:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">device</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
    <span class="n">output</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">iperf</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><p class="first">Calculate start and end times and set the current state to running:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">abort_time</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_time</span>
<span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
</li>
</ol>
</div></blockquote>
<ul class="simple">
<li>The <code class="docutils literal"><span class="pre">self.max_time</span></code> property is used so that a different value can be returned depending on whethe this is a server of client.</li>
</ul>
</div>
<div class="section" id="traverse">
<h3>Traverse<a class="headerlink" href="#traverse" title="Permalink to this headline">¶</a></h3>
<p>The traversal of the output has three paths:</p>
<blockquote>
<div><ol class="arabic simple">
<li>The main path</li>
<li>The abort (timeout) path</li>
<li>The (external) stop path</li>
</ol>
</div></blockquote>
<div class="section" id="the-main-path">
<h4>The Main Path<a class="headerlink" href="#the-main-path" title="Permalink to this headline">¶</a></h4>
<p>The main path is a traversal of the output from the command call:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ValidatingOutput</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">send_line</span><span class="p">(</span><span class="n">file_output</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">send_line</span></code> method traps <cite>StopIteration</cite> exceptions which the would be raised when the output pipeline detects an end-of-file character.</p>
</div>
<div class="section" id="the-abort-path">
<h4>The Abort Path<a class="headerlink" href="#the-abort-path" title="Permalink to this headline">¶</a></h4>
<p>Sometimes devices will stop generating output without quitting and so the <cite>standard-output</cite> will raise a <cite>timeout</cite> forever without reaching an end-of-file character. To prevent this from blocking a timeout is calculated which takes precedence over the end-of-file if it is reached. This is only set for the client, since the server is normally run in a thread.</p>
<p>The abort path is implemented as an extension of the main path (it immediately follows the <cite>send_line</cite> call):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">abort_time</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">send_line</span><span class="p">(</span><span class="n">end_of_file</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">IperfError</span><span class="p">(</span><span class="s2">&quot;aborting&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is an abbreviation, the actual error-message is longer. The reason for the <code class="docutils literal"><span class="pre">now</span></code> method is that in the case that this is a server we do not want to actually calculate a real time.</p>
</div>
<div class="section" id="the-stop-path">
<h4>The Stop Path<a class="headerlink" href="#the-stop-path" title="Permalink to this headline">¶</a></h4>
<p>The stop path is reached if an external agent has asked us to stop. Note that for servers if this call is made after all the output has been read then it will be stuck waiting for the next-line and will reach the stop only on the resumption of output. This is probably not the desired outcome. It would be better to kill the iperf process itself, otherwise you will have a condition where you are trying to consume all the output and then setting stop immediately between the last line read and before reaching the top of the loop again.</p>
<p>Experiments with sending control characters to standard-in seem to indicate that it will not kill the server. However, closing the connection will.</p>
</div>
</div>
</div>
<div class="section" id="the-cleanup">
<h2>The Cleanup<a class="headerlink" href="#the-cleanup" title="Permalink to this headline">¶</a></h2>
<p>After the standard output traversal is completed the <cite>running</cite> state is set to False and standard-error is checked.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If the <cite>abort</cite> or <cite>stop</cite> paths were taken, there is no guarantee that the standard-error is ready to be read. This needs to be made more robust.</p>
</div>
<p>The code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</pre></div>
</div>
<p>Example Use:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">iperf_client</span> <span class="o">=</span> <span class="n">IperfCommand</span><span class="p">(</span><span class="n">client_parameters</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">IperfCommandEnum</span><span class="o">.</span><span class="n">client</span><span class="p">)</span>
<span class="n">iperf_server</span> <span class="o">=</span> <span class="n">IperfCommand</span><span class="p">(</span><span class="n">server_parameters</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">IperfCommandEnum</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
<span class="n">iperf_server</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">server_device</span><span class="p">,</span> <span class="s1">&#39;test_file&#39;</span><span class="p">)</span>
<span class="n">iperf_client</span><span class="p">(</span><span class="n">client_device</span><span class="p">,</span> <span class="s1">&#39;test_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="testing-the-iperf-command">
<h2>Testing The Iperf Command<a class="headerlink" href="#testing-the-iperf-command" title="Permalink to this headline">¶</a></h2>
<table border="1" class="longtable docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">TestIperfCommand.test_daemon</span></code></td>
<td></td>
</tr>
<tr class="row-even"><td><code class="xref py py-obj docutils literal"><span class="pre">TestIperfCommand.test_is_daemon</span></code></td>
<td></td>
</tr>
<tr class="row-odd"><td><code class="xref py py-obj docutils literal"><span class="pre">TestIperfCommand.test_set_parameters</span></code></td>
<td></td>
</tr>
</tbody>
</table>
<div class="code highlight-python"><div class="highlight"><pre><span></span>&lt;class &#39;ImportError&#39;&gt;
No module named &#39;StringIO&#39;
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2014, russelln.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.<br/>
    </p>
  </div>
</footer>
  </body>
</html>